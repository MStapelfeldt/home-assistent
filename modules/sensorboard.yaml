
i2c:
  sda: ${pin_bh1750_sda}
  scl: ${pin_bh1750_scl}
  scan: true
uart:
  id: uart_ld2450
  tx_pin: ${pin_ld2450_tx}
  rx_pin: ${pin_ld2450_rx}
  baud_rate: 256000
  parity: NONE
  stop_bits: 1
ld2450:
  id: ld2450_radar
  uart_id: uart_ld2450

binary_sensor:
  - platform: gpio
    name: "${friendly_name} PIR"
    device_class: motion
    pin:
      number: ${pin_pir}
    filters:
      - delayed_on: 50ms
      - delayed_off: 10s
    id: pir
    on_press:
      if:
        condition:
          switch.is_on: presence_light
        then:
          - light.turn_on: 
              id: sys_status
              red: 100%
              green: 0%
              blue: 0%
  - platform: template
    name: "Occupancy"
    id: occupancy
    device_class: occupancy
    lambda: |-
      if ( id(mmwave).state and id(pir).state) {
        return true;
      }
      else if (id(mmwave).state == 0) {
        return false;
      }
      else {
        return id(occupancy).state;
      }
  - platform: ld2450
    ld2450_id: ld2450_radar
    has_target:
      name: Presence
    id: mmwave
    has_moving_target:
      name: Moving Target
    has_still_target:
      name: Still Target
  - platform: template
    id: is_dark
    name: "${friendly_name} Dunkel"
    lambda: |-
      return (id(light_level).state < id(light_threshold).state);
  - platform: template
    id: dark_and_occupied
    name: "${friendly_name} Dunkel & Belegt"
    device_class: occupancy
    lambda: |-
      return (id(is_dark).state && id(occupancy).state);

number:
  - platform: template
    id: light_threshold
    name: "${friendly_name} Helligkeitsschwelle"
    min_value: 1
    max_value: 200
    step: 1
    initial_value: 30
    optimistic: true
  - platform: ld2450
    ld2450_id: ld2450_radar
    presence_timeout:
      name: "Timeout"
    zone_1:
      x1:
        name: Zone-1 X1
      y1:
        name: Zone-1 Y1
      x2:
        name: Zone-1 X2
      y2:
        name: Zone-1 Y2
    zone_2:
      x1:
        name: Zone-2 X1
      y1:
        name: Zone-2 Y1
      x2:
        name: Zone-2 X2
      y2:
        name: Zone-2 Y2
    zone_3:
      x1:
        name: Zone-3 X1
      y1:
        name: Zone-3 Y1
      x2:
        name: Zone-3 X2
      y2:
        name: Zone-3 Y2

switch:
  - platform: template
    name: Presence Light
    id: presence_light
    entity_category: config
    optimistic: true
    restore_mode: RESTORE_DEFAULT_ON
    on_turn_on:
      if:
        condition:
          binary_sensor.is_on: occupancy
        then:
          - light.turn_on: led
    on_turn_off:
      - light.turn_off: led
  - platform: ld2450
    ld2450_id: ld2450_radar
    bluetooth:
      name: "Bluetooth"
    multi_target:
      name: "Multi Target Tracking"

select:
  - platform: ld2450
    ld2450_id: ld2450_radar
    baud_rate:
      name: "Baud rate"
    zone_type:
      name: "Zone Type"

button:
  - platform: ld2450
    ld2450_id: ld2450_radar
    factory_reset:
      name: "LD2450 Factory Reset"
      entity_category: "config"
    restart:
      name: "LD2450 Restart"
      entity_category: "config"

text_sensor:
  - platform: ld2450
    ld2450_id: ld2450_radar
    version:
      name: "LD2450 Firmware"
    mac_address:
      name: "LD2450 BT MAC"
    target_1:
      direction:
        name: "Target-1 Direction"
    target_2:
      direction:
        name: "Target-2 Direction"
    target_3:
      direction:
        name: "Target-3 Direction"

sensor:
  - platform: wifi_signal
    name: "WiFi Signal (dBm)"
    id: wifi_signal_db
    update_interval: 60s
    unit_of_measurement: "dBm"
    device_class: signal_strength
    accuracy_decimals: 0
    entity_category: "diagnostic"

  - platform: copy
    source_id: wifi_signal_db
    name: "WiFi Signal (%)"
    filters:
      - lambda: return min(max(2 * (x + 100.0), 0.0), 100.0);
    unit_of_measurement: "%"
    device_class: ""
    accuracy_decimals: 0
    entity_category: "diagnostic"
  - platform: uptime
    name: "Uptime Sensor"
    update_interval: 60s
    entity_category: "diagnostic"
  - platform: bh1750
    id: light_level
    name: "${friendly_name} Helligkeit"
    address: 0x23
    update_interval: 1s
    filters:
      - sliding_window_moving_average:
          window_size: 10
          send_every: 10
          send_first_at: 1
      - or:
          - throttle: 60s
          - delta: 5
  - platform: ld2450
    ld2450_id: ld2450_radar
    target_count:
      name: Presence Target Count
  - platform: ld2450
    ld2450_id: ld2450_radar
    still_target_count:
      name: Still Target Count
  - platform: ld2450
    ld2450_id: ld2450_radar
    moving_target_count:
      name: Moving Target Count
  - platform: ld2450
    ld2450_id: ld2450_radar
    target_1:
      x:
        name: Target-1 X
      y:
        name: Target-1 Y
      speed:
        name: Target-1 Speed
      angle:
        name: Target-1 Angle
      distance:
        name: Target-1 Distance
      resolution:
        name: Target-1 Resolution
    target_2:
      x:
        name: Target-2 X
      y:
        name: Target-2 Y
      speed:
        name: Target-2 Speed
      angle:
        name: Target-2 Angle
      distance:
        name: Target-2 Distance
      resolution:
        name: Target-2 Resolution
    target_3:
      x:
        name: Target-3 X
      y:
        name: Target-3 Y
      speed:
        name: Target-3 Speed
      angle:
        name: Target-3 Angle
      distance:
        name: Target-3 Distance
      resolution:
        name: Target-3 Resolution
    zone_1:
      target_count:
        name: Zone-1 All Target Count
      still_target_count:
        name: Zone-1 Still Target Count
      moving_target_count:
        name: Zone-1 Moving Target Count
    zone_2:
      target_count:
        name: Zone-2 All Target Count
      still_target_count:
        name: Zone-2 Still Target Count
      moving_target_count:
        name: Zone-2 Moving Target Count
    zone_3:
      target_count:
        name: Zone-3 All Target Count
      still_target_count:
        name: Zone-3 Still Target Count
      moving_target_count:
        name: Zone-3 Moving Target Count

light:
  - platform: esp32_rmt_led_strip
    rgb_order: GRB
    pin: ${pin_ws2812}
    num_leds: 1
    chipset: ws2812
    id: sys_status
    name: "${friendly_name} Status LED"

interval:
  - interval: 200ms
    then:
      - if: # 1. Dunkel & Belegt → GELB (höchste Priorität)
          condition:
            and:
              - binary_sensor.is_on: occupancy
              - binary_sensor.is_on: is_dark
          then:
            - light.turn_on:
                id: sys_status
                red: 50%
                green: 50%
                blue: 0%
      - if: # 2. PIR + Radar → ROT
          condition:
            and:
              - binary_sensor.is_on: pir
              - binary_sensor.is_on: mmwave
          then:
            - light.turn_on:
                id: sys_status
                red: 50%
                green: 0%
                blue: 0%
      - if: # 3. Nur Radar → GRÜN
          condition:
            and:
              - binary_sensor.is_off: pir
              - binary_sensor.is_on: mmwave
          then:
            - light.turn_on:
                id: sys_status
                red: 0%
                green: 50%
                blue: 0%
      - if: # 4. Nur PIR → GELB gedimmt
          condition:
            and:
              - binary_sensor.is_on: pir
              - binary_sensor.is_off: mmwave
          then:
            - light.turn_on:
                id: sys_status
                red: 50%
                green: 50%
                blue: 0%
      - if: # 5. Dunkel, aber niemand da → BLAU gedimmt
          condition:
            and:
              - binary_sensor.is_off: occupancy
              - binary_sensor.is_on: is_dark
          then:
            - light.turn_on:
                id: sys_status
                red: 0%
                green: 0%
                blue: 50%
      - if: # 6. Hell & leer → LED aus
          condition:
            and:
              - binary_sensor.is_off: occupancy
              - binary_sensor.is_off: is_dark
          then:
            - light.turn_off: sys_status
